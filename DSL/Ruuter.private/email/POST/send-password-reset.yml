declaration:
  call: declare
  version: 1.0
  description: "Send password reset email"
  method: post
  accepts: json
  returns: json
  namespace: email
  allowlist:
    body:
      - field: email
        type: string
        description: "User email"
      - field: locale
        type: string
        description: "Locale (et, en, ru)"

extract_data:
  assign:
    email: ${incoming.body.email}
    locale: ${incoming.body.locale ?? 'et'}
  next: generate_reset_token

generate_reset_token:
  call: http.post
  args:
    url: "[#CHATBOT_RESQL]/generate-reset-token"
    body:
      email: ${email}
      expiresAt: ${new Date(Date.now() + 3600000).toISOString()}  # 1 hour
  result: token_result
  next: prepare_email

prepare_email:
  assign:
    emailRequest:
      eventId: ${java.util.UUID.randomUUID().toString()}
      eventType: "password_reset"
      recipientEmail: ${email}
      templateId: "password-reset"
      priority: "high"
      locale: ${locale}
      templateData:
        resetUrl: "[#BASE_URL]/reset-password?token=${token_result.response.body[0]?.token ?? ''}"
        expiresAt: ${token_result.response.body[0]?.expiresAt ?? new Date(Date.now() + 3600000).toISOString()}
  next: send_email

send_email:
  call: http.post
  args:
    url: "[#EMAIL_NOTIFICATION_SERVICE]/email/send"
    body: ${emailRequest}
  result: email_result
  next: return_success

return_success:
  return:
    messageId: ${email_result.response.body.messageId}
    status: ${email_result.response.body.status}
  next: end

error_handler:
  status: 500
  return:
    error: "Failed to send password reset email"
  next: end
